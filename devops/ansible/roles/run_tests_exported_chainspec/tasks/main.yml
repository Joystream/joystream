- name: run network
  block:
    - name: yarn install
      shell: yarn

      # is this step necessary?
      # related to 'link' dependency? "@alexandria/types": "link:../../types"
    - name: yarn install for network tests
      shell: yarn workspace joystream-testing install

    # TODO: build chainspec into "{{ playbook_dir }}/../../testnets/nicaea-exported-state"
    # - name: build chainspec
    # ...

    - name: run docker container
      docker_container:
        name: "joystream-node-testing-b"
        image: "joystream/node:alexandria"
        ports:
          - "9944:9944"
        mounts:
          - target: /testnet-state
            source: "{{ playbook_dir }}/../../testnets/nicaea-exported-state"
            type: bind
            read_only: yes
        entrypoint: ./node --chain /testnet-state/raw_chain_spec.json --alice --validator --unsafe-ws-external --rpc-cors=all --force-authoring
        state: started

    - name: execute network tests
      shell: yarn test >> ../../.tmp/tests.log
      args:
        chdir: ../../tests/network-tests/

  always:
    - name: display tests log
      shell: cat ../../.tmp/tests.log

    - name: stop docker container
      docker_container:
        name: "joystream-node-testing-b"
        state: absent
