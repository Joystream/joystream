---
# Configure chain spec and start joystream-node service on the servers

- name: Run subkey to generate node keys
  local_action: command {{ local_dir }}/target/release/chain-spec-builder generate -a 2 --chain-spec-path {{ change_spec_path }} --deployment live --endowed 1 --keystore-path {{ data_path }}
  register: chain_spec_output
  run_once: true

- name: Run subkey to generate node keys
  local_action: command subkey generate-node-key
  register: subkey_output

- name: Print to stdout
  debug:
    msg:
    - "Public Key: {{ subkey_output.stderr }}"
    - "Private Key: {{ subkey_output.stdout }}"

- name: Print to stdout chain spec
  debug: var=chain_spec_output.stdout
  run_once: true

- name: Save output of chain spec to local file
  local_action: copy content={{ chain_spec_output.stdout }} dest="{{ data_path }}/chain_spec_output.txt"

- name: Change chain spec name, id, protocolId
  delegate_to: localhost
  json_modify:
    change_spec_path: "{{ change_spec_path }}"
    prefix: "{{ network_suffix }}"
    all_nodes: "{{ hostvars }}"
  register: result
  run_once: true

- name: Print output of modified chainspec
  debug:
    var: result.result
  run_once: true

- name: Copying chain spec file to server
  copy:
    src: "{{ change_spec_path }}"
    dest: "{{ remote_chain_spec_path }}"
