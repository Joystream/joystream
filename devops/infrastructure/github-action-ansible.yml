---
# Testing github actions with ansible playnook

- name: Setup instance
  hosts: all

  tasks:
    - name: Debug information
      debug:
        msg: "Variables are: {{ hostvars }}"

    - name: Get code from git repo
      include_role:
        name: common
        tasks_from: get-code-git

    # - name: Run setup and build
    #   include_role:
    #     name: common
    #     tasks_from: run-setup-build

    - name: Basic AMI Creation
      amazon.aws.ec2_ami:
        instance_id: "{{ instance_id }}"
        wait: yes
        name: "joystream-{{ branch_name }}"
        launch_permissions:
          group_names: ['all']
      register: ami_data
      delegate_to: localhost

    - name: Print AMI Data
      debug:
        msg: "AMI Data is: {{ ami_data }}"

    - name: Print AMI ID
      debug:
        msg: "AMI ID is: {{ ami_data.image_id }}"

    - name: delete a stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        state: "absent"
