# Joystream Query Node

Joystream query node can be generated by using `substrate-query-node/cli`.

## Getting Started

Cli create a folder named `generated` and put everthing inside it.

```
$ cli codegen
```

Start graphql server:

```
$ cd generated/graphql-server
$ yarn start:dev
```

Start block indexer:

```
$ cd generated/indexer
$ yarn start
```

#### Add a new mapping for Joystream MemberRegistered event

1. Every mapping function get a parameter of `QueryEvent` type

```ts
import { QueryEvent, db } from "../generated/indexer/index";
```

2. `db` object for database operations: save/get/remove

```ts
import { db } from "../generated/indexer/index";
```

3. Define the event handler function with the following signature

```ts
export async function handleMemberRegistered(event: QueryEvent) {}
```

4. Inside the handler function create a new instance of the entity and fill properties with event data.

```ts
const member = new MemberRegistereds();
// Get event data
const { AccountId, MemberId } = event.event_params;

member.accountId = AccountId;
member.memberId = +MemberId;
```

5. Call `db.save()` method to save data on database

```ts
// Save to database.
db.save(member, event);
```

6. Query database

```ts
// Query from database
const m = await db.get("MemberRegistereds", { memberId: MemberId });
console.log(m);
```

**Notes**
`db.save()` method take two parameters entity instance and event. `db.save()` method use `event` to keep track of last processed event.

`db.get()` method. The first parameter is the name of the entity class to query and the second parameter is the find options (to match record).

**Complete code**

```ts
import { MemberRegistereds } from "../generated/indexer/entities/MemberRegistereds";
import { QueryEvent, db } from "../generated/indexer/index";

export async function handleMemberRegistered(event: QueryEvent) {
  const member = new MemberRegistereds();

  // Get event data
  const { AccountId, MemberId } = event.event_params;

  member.accountId = AccountId;
  member.memberId = +MemberId;

  // Save to database.
  db.save(member, event);

  // Query from database
  const m = await db.get("MemberRegistereds", { memberId: MemberId });
  console.log(m);
}
```

#### Query Node Constructs Explained

1. `schema.json` is where you define types for graphql server. Graphql server use these types to generate db models, db tables, graphql resolvers.

Below you can find a type defination example:

```json
[
  {
    "name": "MemberRegistered",
    "fields": [
      { "name": "memberId", "type": "int!" },
      {
        "name": "accountId",
        "type": "string!"
      }
    ]
  }
]
```

2. Block indexer is block consumer and every block can have events that we want to store their data. So indexing data from events we need to send the event to a function or a class that can handle the event and store the event data on database. `mappings` are the functions that we use to update our database with events data. Functions that we define in our mappings will be called only when an event name match our function name (function name pattern is `'handle' + eventName`). We call mapping functions as event handlers. Each event handler will have only one parameter which is the event that handler called for. Below you can find an example for event an handler:

```ts
// mappings/index.ts

import { QueryEvent } from "../generated/indexer/index";

export function handleMemberRegistered(event: QueryEvent) {
  console.log(`Event parameters: ${event.event_params}`);
}
```

3. Block indexer connect to a blockchain node via websockets so we need to tell block indexer where to find the address of the node. Also, on the initialization of the indexer we must pass type register function as a parameter. So we put these variables inside the `.env` file that indexer can find and use them. For Joystream we will be running a local development node and add name of the function, package for the type registrator:

```
WS_PROVIDER_ENDPOINT_URI=ws://localhost:9944
TYPE_REGISTER_PACKAGE_NAME=@joystream/types
TYPE_REGISTER_FUNCTION=registerJoystreamTypes
```

4. Database connections options are defined in `.env`:

```
DB_NAME=test
DB_USER=postgres
DB_PASS=postgres
DB_HOST=localhost
DB_PORT=5432
GRAPHQL_SERVER_PORT=4000
```
